<!DOCTYPE html>
<html>

<head>
    <title> Coursera </title>

    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/watson.css" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />

    <script src="lib/jquery/dist/jquery.min.js"></script>
    <script src="lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/lodash/lodash.min.js"></script>
    <script src="https://kit.fontawesome.com/4d89d52e05.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
    <div class="jumbotron text-center">
        <h1>Watson Product List</h1>
        <p>Product List , Promotion List</p>
    </div>

    <div class="card card-body m-4" style="height: 200px; overflow: auto;">
        <div class="d-block">
            <div class="w-50 float-right" style="z-index: 999">
                <h6>Brands :</h6>
                <div id="brandList"></div>
            </div>

            <div class="w-25 sticky-top">
                <div class="mb-2">
                    <span>Brand :</span>
                    <select id="brandInput">
                </select>
                </div>

                <div class="mb-4">
                    <span>Products :</span>
                    <select id="productInput">
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                </select>
                </div>

                <button id="load" class="btn btn-dark btn-sm">Refresh</button>
            </div>
        </div>
    </div>

    <div class="card card-body m-4">
        <table id="productTable"></table>
    </div>
</body>

<footer style="height: 100px; width: 100%">
    <div class="jumbotron text-center text-white bg-dark">
        <div>
            <img class="d-inline" style="margin-top:-20px; margin-right: 10px; border-radius: 50%;" src="images/panda.jpg" height="48" width="48">
            <h1 class="d-inline">Murnesty</h1>
        </div>
        <p class="mt-2">for study purpose</p>
    </div>
</footer>

</html>


<script type="text/javascript">
    function _setupBrandSelectBox(element, brands) {
        brands.forEach(x =>
            element
            .append(
                $("<option>")
                .text(x.name)
            )
        );
    }

    function _setupBrandList(element, data) {
        var brandGroup = _.groupBy(data.brands, (x) => x.name.slice(0, 1));
        for (var firstChar in brandGroup) {
            element
                .append(
                    _setupMainItemButton(brandGroup, firstChar)
                )
                .append(
                    $("<div>")
                    .addClass("panel")
                    .append(
                        _setupSubList(brandGroup, firstChar)
                    )
                );
        }

        function _setupMainItemButton(brandGroup, firstChar) {
            return $("<button>")
                .addClass("accordion")
                .text(firstChar)
                .click(function() {
                    this.classList.toggle("active");

                    /* Toggle between hiding and showing the active panel */
                    var panel = this.nextElementSibling;
                    if (panel.style.display === "block") {
                        panel.style.display = "none";
                    } else {
                        panel.style.display = "block";
                    }
                })
                .append(
                    $("<div>")
                    .addClass("my-auto badge rounded-pill bg-primary text-white float-right")
                    .text(brandGroup[firstChar].length.toString())
                );
        }

        function _setupSubList(brandGroup, firstChar) {
            return $("<ul>")
                .addClass("my-1")
                .append(
                    brandGroup[firstChar]
                    .map((x) => {
                        var items = x.brandUrl.split("/");

                        return $("<li>")
                            .addClass("mb-1")
                            .append(
                                $("<button>")
                                .attr("data-brand-code", items[items.length - 2]) // x.brandUrl.slice(0, x.brandUrl.lastIndexOf("/") + 1)
                                .addClass("btn btn-outline-secondary btn-sm m-0")
                                .text(x.name)
                                .click(function(e) {
                                    $("#brandInput")
                                        .attr("data-brand-code", this.dataset.brandCode)
                                        .val(this.outerText);
                                })
                            );
                    })
                )
        }

    }

    function _setupRefreshClick(element) {
        element.click(function(e) {
            var productUrl = `https://cors.bridged.cc/https://api.watsons.com.my/api/v2/wtcmy/products/search?fields=FULL&query=%3AproductBrandCode%3AproductBrandCode%3A${$("#brandInput").attr("data-brand-code")}&pageSize=32&sort=bestSeller&lang=en&curr=MYR`;
            $.ajax({
                    headers: {
                        "Accept": "application/json"
                    },
                    type: 'GET',
                    url: productUrl,
                    crossDomain: true,
                    beforeSend: function(xhr) {
                        xhr.withCredentials = true;
                    }
                })
                .done(function(data) {
                    console.log(data.products);

                    $("#productTable")
                        .empty()
                        .append(
                            _.chain(data.products)
                            .orderBy("name")
                            .map((p) => {
                                return $("<tr>")
                                    // .append($("<th>").text((p.masterBrand || {}).code))
                                    // .append($("<th>").text((p.code || "")))
                                    .append($("<th>").text((p.masterBrand || {}).name))
                                    .append($("<th>").text((p.name || "")))
                                    .append($("<th>").text((p.elabMarkDownPrice || {}).value))
                                    .append($("<th>").text((p.price || {}).value));
                            })
                            .value()
                        );
                })
                .fail(function(ex) {
                    alert("fail");
                })
                .always(function() {});
        });
    }

    $(document).ready(function() {
        _setupRefreshClick($("#load"));

        $.ajax({
                headers: {
                    "Accept": "application/json"
                },
                type: 'GET',
                url: "https://cors.bridged.cc/https://api.watsons.com.my/api/v2/wtcmy/brands?fields=FULL&lang=en&curr=MYR",
                crossDomain: true,
                beforeSend: function(xhr) {
                    xhr.withCredentials = true;
                }
            })
            .done(function(data) {
                _setupBrandSelectBox($("#brandInput"), data.brands);
                _setupBrandList($("#brandList"), data);
            })
            .fail(function(ex) {
                alert("fail");
            })
            .always(function() {});
    });
</script>